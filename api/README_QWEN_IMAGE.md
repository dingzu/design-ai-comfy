# Qwen-Image 节点使用说明

本文档介绍基于万擎平台的Qwen-Image模型开发的两个ComfyUI节点的使用方法。

## 节点概述

### 1. Qwen-Image 文本生成图像 (QwenImageText2Img)

使用阿里云Qwen-Image模型，通过文本描述生成高质量图像。支持中文文本渲染、复杂布局等高级功能。

### 2. Qwen-Image 图像编辑 (QwenImageEdit)

基于Qwen-Image模型的图像编辑功能，支持普通编辑、修复(inpaint)、扩展(outpaint)等多种编辑模式。

## 前置条件

1. **万擎网关API Key**: 联系 @于淼 获取万擎网关访问密钥
2. **网络连接**: 确保能访问万擎网关服务器

## 文本生成图像节点使用

### 输入参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| environment | 选择 | prod | 万擎网关环境 (prod/staging/idc) |
| api_key | 字符串 | - | 万擎网关API密钥 |
| prompt | 字符串 | "生成一个美丽的风景画" | 图像描述提示词 |
| image_count | 整数 | 1 | 生成图像数量 (1-4) |
| image_size | 选择 | 1328*1328 | 图像尺寸 |
| prompt_extend | 布尔 | True | 是否开启提示词扩展 |
| watermark | 布尔 | True | 是否添加水印 |
| timeout | 浮点 | 180.0 | 请求超时时间（秒） |
| poll_interval | 浮点 | 5.0 | 任务状态查询间隔（秒） |

### 支持的图像尺寸

- `1328*1328` (1:1，默认)
- `1664*928` (16:9)
- `1472*1140` (4:3)
- `1140*1472` (3:4)
- `928*1664` (9:16)

### 输出

- **images**: 生成的图像张量
- **response_json**: 完整的API响应JSON
- **usage_info**: 使用统计信息
- **task_info**: 任务执行信息

### 使用示例

```
提示词: "一副典雅庄重的对联悬挂于厅堂之中，房间是个安静古典的中式布置，对联上左书'义本生知人机同道善思新'，右书'通云赋智乾坤启数高志远'，横批'智启通义'"
```

## 图像编辑节点使用

### 输入参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| environment | 选择 | prod | 万擎网关环境 |
| api_key | 字符串 | - | 万擎网关API密钥 |
| image | 图像 | - | 要编辑的输入图像 |
| prompt | 字符串 | "修改这张图片" | 图像编辑指令 |
| edit_type | 选择 | edit | 编辑类型 |
| image_size | 选择 | auto | 输出图像尺寸 |
| image_count | 整数 | 1 | 生成图像数量 |
| watermark | 布尔 | True | 是否添加水印 |
| timeout | 浮点 | 180.0 | 请求超时时间（秒） |
| poll_interval | 浮点 | 5.0 | 任务状态查询间隔（秒） |
| mask (可选) | 蒙版 | - | 编辑蒙版 |

### 编辑类型

- **edit**: 普通编辑，根据提示词修改图像
- **inpaint**: 修复编辑，通常配合蒙版使用
- **outpaint**: 扩展编辑，扩展图像边界

### 输出

- **images**: 编辑后的图像张量
- **response_json**: 完整的API响应JSON
- **usage_info**: 使用统计信息
- **task_info**: 任务执行信息

### 使用示例

```
编辑指令: "给这张图片添加一只可爱的小猫"
编辑类型: edit
```

## 工作流程

两个节点都采用异步API模式：

1. **任务提交**: 向万擎网关提交生成/编辑任务
2. **状态轮询**: 定期查询任务执行状态
3. **结果下载**: 任务完成后下载生成的图像
4. **格式转换**: 将图像转换为ComfyUI兼容的张量格式

## 错误处理

### 常见错误及解决方案

1. **API Key错误**: 检查密钥是否正确，联系 @于淼 获取有效密钥
2. **网络连接失败**: 检查网络连接和万擎网关访问权限
3. **任务超时**: 增加timeout参数值，Qwen-Image生成可能需要较长时间
4. **图像下载失败**: 检查网络连接，可能是临时网络问题

### 调试信息

节点会在控制台输出详细的调试信息：
- 请求URL和参数
- 任务ID和状态
- 轮询进度
- 图像下载状态

## 性能建议

1. **提示词扩展**: 简单提示词建议开启，详细提示词建议关闭
2. **轮询间隔**: 建议设置为5-10秒，避免过于频繁的请求
3. **超时时间**: 复杂图像建议设置3-5分钟超时
4. **批量生成**: 利用image_count参数一次生成多张图像更高效

## 技术特性

### Qwen-Image模型优势

- **中文文本渲染**: 支持复杂中文字体和布局
- **高质量输出**: 生成细节丰富、质量较高的图像
- **多种尺寸**: 支持多种常用宽高比
- **提示词扩展**: 自动优化和扩展提示词

### 节点特性

- **异步处理**: 支持长时间任务，不阻塞ComfyUI界面
- **错误重试**: 自动处理网络临时故障
- **详细日志**: 提供完整的执行过程信息
- **格式兼容**: 输出标准ComfyUI图像张量格式

## 更新日志

### v1.0.0 (2025-01-01)

- 初始版本发布
- 支持文本生成图像
- 支持图像编辑功能
- 集成万擎网关API
- 支持异步任务处理

## 技术支持

如有问题，请联系：
- API密钥: @于淼
- 技术问题: 开发团队

---

**注意**: 本节点仅支持万擎平台的Qwen-Image API，不支持其他平台或直接调用阿里云API。
